<!-- ============================================
     PDF-NAV Widget HTML Template
     ============================================
     Layout: Left sidebar (Fields) + Right panel (PDF Viewer)
     Features: Document selection, searchable fields table, save functionality
     ============================================ -->

<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?display=swap&family=Segoe+UI:wght@300;400;600;700&family=Inter:wght@400;500;600;700" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="pdf-viewer-container">

  <!-- ============================================
       LOADING OVERLAY
       Shows during data fetch/save operations
       ============================================ -->
  <div class="loading-overlay" ng-show="c.isLoading">
    <div class="loader-container">
      <div class="spinner"></div>
      <p class="loading-text">{{c.loadingMessage}}</p>
    </div>
  </div>

  <!-- ============================================
       MAIN LAYOUT
       Two-column layout: Fields (left) + PDF (right)
       ============================================ -->
  <div class="main-layout">

    <!-- ============================================
         LEFT SIDEBAR - FIELDS PANEL
         Contains: Header, Document selector, Search, Fields table
         ============================================ -->
    <div class="left-sidebar">

      <!-- Header with Title and Action Buttons -->
      <div class="fields-header">
        <div class="header-row">
          <h2 class="fields-title">Fields</h2>

          <!-- Action Buttons: Refer, Save, Done -->
          <div class="header-actions">
            <button class="btn-refer" ng-click="c.referSubmission()" ng-disabled="c.isLoading || c.isSaving">
              Refer
            </button>
            <button class="btn-save" ng-click="c.saveAllChanges()"
              ng-disabled="c.isLoading || c.isSaving || !c.hasChanges">
              <i class="fas fa-spinner fa-spin" ng-show="c.isSaving"></i>
              <span ng-hide="c.isSaving">Save</span>
              <span ng-show="c.isSaving">Saving...</span>
            </button>
            <button class="btn-done" ng-click="c.markAsComplete()"
              ng-disabled="c.isLoading || c.isSaving || !c.hasChanges">
              <i class="fas fa-spinner fa-spin" ng-show="c.isCompleting"></i>
              <span ng-hide="c.isCompleting">Complete</span>
              <span ng-show="c.isCompleting">Completing...</span>
            </button>
            <!-- <button class="btn-more" title="More options">
              <i class="fas fa-ellipsis-v"></i>
            </button> -->
          </div>
        </div>

        <!-- Document Selector Dropdown -->
        <div class="document-selector">
          <select ng-model="c.selectedDocument" ng-change="c.loadDocument()" ng-disabled="c.isLoading"
            ng-options="doc as (c.getDocumentFieldCount() + ' of ' + c.getTotalCount() + ' (' + doc.name + ')') for doc in c.documents track by doc.url"
            class="document-dropdown">
          </select>
        </div>

        <!-- Search Input -->
        <div class="search-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" ng-model="c.fieldSearch" placeholder="Search fields..." class="search-input">
        </div>
      </div>

      <!-- ============================================
           FIELDS CONTENT
           Grouped sections with expandable tables
           ============================================ -->
      <div class="fields-content">

        <!-- Loop through grouped field sections -->
        <div ng-repeat="(sectionName, fields) in c.groupedFields" class="field-section">

          <!-- Section Header (Collapsible) -->
          <div class="section-header" ng-click="c.collapsedSections[sectionName] = !c.collapsedSections[sectionName]">
            <div class="section-title-wrapper">
              <i class="fas" ng-class="c.collapsedSections[sectionName] ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
              <span class="section-title">{{c.trimInitialNumberAdvanced(sectionName)}} ({{fields.length}})</span>
            </div>
            <div class="section-accuracy" ng-if="fields.length > 0">
              {{c.calculateSectionAccuracy(fields) | number:2}}%
            </div>
          </div>

          <!-- Section Table (Fields) -->
          <div class="section-table-wrapper" ng-show="!c.collapsedSections[sectionName]">
            <table class="fields-table">
              <thead>
                <tr>
                  <th class="col-field-name">Field Name</th>
                  <th class="col-ai-value">AI Value</th>
                  <th class="col-data-verification">Data Verification</th>
                  <th class="col-qa-override">QA Override Value</th>
                  <th class="col-logic">Logic Transparency</th>
                  <th class="col-commentary">Commentary</th>
                </tr>
              </thead>
              <tbody>
                <!-- Field Rows -->
                <tr ng-repeat="field in fields | filter:{field_name: c.fieldSearch}" ng-click="c.navigateToField(field)"
                  ng-class="{
                      'active-field': field === c.activeField,
                      'inactive-field': !c.isFieldActive(field)
                    }">

                  <!-- Field Name + Confidence -->
                  <td class="col-field-name">
                    <div class="field-name-cell">
                      <span class="field-name">{{field.field_name}}</span>
                      <span class="confidence-pill" ng-class="c.getConfidencePillClass(field.confidence_indicator)">
                        {{field.confidence_indicator * 100 | number:0}}%
                      </span>
                    </div>
                  </td>

                  <!-- AI Value (Read-only) -->
                  <td class="col-ai-value">
                    <span class="ai-value-text" ng-class="{'has-value': field.field_value}">
                      {{field.field_value || '-'}}
                    </span>
                  </td>

                  <!-- Data Verification (Editable when status = 'a', otherwise read-only) -->
                  <td class="col-data-verification" ng-click="$event.stopPropagation()">
                    <!-- Editable input when submission_status_choice is 'a' -->
                    <input type="text" class="verification-input" ng-model="field.data_verification"
                      ng-if="c.submissionStatusChoice !== c.qaKey" ng-change="c.markFieldAsChanged(field)"
                      ng-blur="c.autoSaveField(field)" ng-disabled="false && !c.isFieldActive(field)"
                      placeholder="Enter verification...">
                    <!-- Read-only text when submission_status_choice is not 'a' -->
                    <span class="verification-text" ng-if="c.submissionStatusChoice === c.qaKey">
                      {{field.data_verification || '-'}}
                    </span>
                  </td>

                  <!-- QA Override Value (Editable when status = 'b', otherwise read-only) -->
                  <td class="col-qa-override" ng-click="$event.stopPropagation()">
                    <!-- Editable input when submission_status_choice is 'b' -->
                    <input type="text" class="override-input" ng-model="field.override_value"
                      ng-if="c.submissionStatusChoice === 'b'" ng-change="c.markFieldAsChanged(field)"
                      ng-blur="c.autoSaveField(field)" ng-disabled="false && !c.isFieldActive(field)"
                      placeholder="Enter override...">
                    <!-- Read-only text when submission_status_choice is not 'b' -->
                    <span class="override-text" ng-if="c.submissionStatusChoice !== 'b'">
                      {{field.override_value || '-'}}
                    </span>
                  </td>

                  <!-- Logic Transparency (Always truncated with popover) -->
                  <td class="col-logic">
                    <div class="logic-cell" ng-class="{'has-value': field.logic_transparency}">
                      <span class="logic-text-truncated">{{c.truncateText(field.logic_transparency, 25) || 'Extracted
                        from...'}}</span>
                      <div class="logic-popover"
                        ng-if="field.logic_transparency && field.logic_transparency.length > 25">
                        <i class="fas fa-info-circle logic-info-icon"></i>
                        <div class="logic-popover-content">{{field.logic_transparency}}</div>
                      </div>
                    </div>
                  </td>

                  <!-- Commentary (Read-only) -->
                  <td class="col-commentary">
                    <span class="commentary-text">{{field.commentary || '-'}}</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" ng-if="!c.groupedFields || c.getObjectKeys(c.groupedFields).length === 0">
          <i class="fas fa-file-alt empty-icon"></i>
          <p>No fields available</p>
          <p class="empty-hint" ng-if="!c.isLoading">Select a document to view extracted fields</p>
        </div>
      </div>

      <!-- Save Status Bar -->
      <div class="save-status-bar"
        ng-class="{'saving': c.saveStatus === 'saving', 'saved': c.saveStatus === 'saved', 'error': c.saveStatus === 'error'}"
        ng-show="c.saveStatus">
        <i class="fas fa-spinner fa-spin" ng-show="c.saveStatus === 'saving'"></i>
        <i class="fas fa-check-circle" ng-show="c.saveStatus === 'saved'"></i>
        <i class="fas fa-exclamation-circle" ng-show="c.saveStatus === 'error'"></i>
        <span>{{c.saveStatusMessage}}</span>
      </div>
    </div>

    <!-- ============================================
         RIGHT PANEL - PDF VIEWER
         Contains: Header, Canvas, Footer
         ============================================ -->
    <div class="pdf-panel">

      <!-- PDF Header -->
      <div class="pdf-header">
        <div class="pdf-title">
          <i class="fas fa-file-pdf"></i>
          <span ng-if="c.selectedDocument">{{c.selectedDocument.name}}</span>
          <span ng-if="!c.selectedDocument">No document selected</span>
        </div>

        <div class="pdf-controls">
          <!-- Zoom Controls -->
          <div class="control-group">
            <button ng-click="c.fitWidth()" ng-disabled="c.isLoading || !c.pdfLoaded" class="btn-icon"
              ng-class="{'active': c.zoomMode === 'fit-width'}" title="Fit to Width">
              <i class="fa-solid fa-arrows-left-right-to-line"></i>
            </button>
            <button ng-click="c.actual100Percent()" ng-disabled="c.isLoading || !c.pdfLoaded" class="btn-icon"
              ng-class="{'active': c.zoomMode === 'actual-size'}" title="Actual Size (100%)">
              <i class="fa-solid fa-text-height"></i>
            </button>
          </div>

          <!-- Page Navigation -->
          <div class="control-group">
            <button ng-click="c.previousPage()" ng-disabled="c.currentPage <= 1 || c.isLoading" class="btn-icon"
              title="Previous Page">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="page-info">
              <span>Page {{c.currentPage}} of {{c.totalPages}}</span>
            </div>
            <button ng-click="c.nextPage()" ng-disabled="c.currentPage >= c.totalPages || c.isLoading" class="btn-icon"
              title="Next Page">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- PDF Content Area -->
      <div class="pdf-content" id="pdfContainer">
        <div class="pdf-canvas-wrapper">
          <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
          <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
          <div id="pageMarker" class="page-marker"></div>
        </div>
      </div>

      <!-- PDF Footer -->
      <div class="pdf-footer">
        <div class="footer-content">
          <span class="footer-item">
            <i class="fas fa-file"></i>
            A4: 595 Ã— 842 points
          </span>
          <span class="footer-item">
            <i class="fas fa-expand"></i>
            Scale: {{(c.scale * 100) | number:0}}%
          </span>
          <span class="footer-item" ng-if="c.activeField">
            <i class="fas fa-crosshairs"></i>
            Active: {{c.activeField.field_name}}
            <span ng-if="c.activeField.allCoordinates && c.activeField.allCoordinates.length > 1">
              ({{c.activeFieldCoordIndex + 1}}/{{c.activeField.allCoordinates.length}})
            </span>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>