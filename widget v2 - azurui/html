<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Segoe+UI:wght@300;400;600;700&family=Inter:wght@400;500;600;700" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="pdf-viewer-container">
  <!-- Loading Overlay -->
  <div class="loading-overlay" ng-show="c.isLoading">
    <div class="loader-container">
      <div class="spinner"></div>
      <p class="loading-text">{{c.loadingMessage}}</p>
    </div>
  </div>
  
  <!-- Main Layout -->
  <div class="main-layout">
    <!-- Left Sidebar -->
    <div class="left-sidebar">
      <!-- Header -->
      <div class="sidebar-header">
        <div class="brand">
          <i class="fas fa-file-invoice"></i>
          <span>Pre-Bind Suite</span>
        </div>
      </div>
      
      <!-- Document Selector -->
      <div class="section">
        <label class="section-label">Select Document</label>
        <div class="select-wrapper">
          <select ng-model="c.selectedDocument" 
            ng-change="c.loadDocument()" 
            ng-disabled="c.isLoading"
            ng-options="doc as doc.name for doc in c.documents track by doc.url"
            class="form-select">
        	</select>
        	<i class="fas fa-chevron-down select-icon"></i>
      	</div>
    	</div>
    
      <!-- Advanced Mode Toggle -->
      <div class="section" ng-if="c.showAdvancedButton">
        <button ng-click="c.showAdvancedMode = !c.showAdvancedMode" 
        	class="advanced-toggle"
        	ng-class="{'active': c.showAdvancedMode}">
        	<span>Advanced Mode</span>
        	<i class="fas fa-chevron-down" ng-class="{'rotate-180': c.showAdvancedMode}"></i>
      	</button>
    
      	<div ng-show="c.showAdvancedMode" class="advanced-panel">
        	<div class="form-group">
          	<label class="form-label">Coordinate Strings (Multiple D Formats)</label>
          	<textarea ng-model="c.manualCoordinate"
          		placeholder="D(1,100,200,150,250,100,300,150,350);D(2,50,100,150,200,250,300,350,400)"
          		class="form-textarea"
          		rows="3">
            </textarea>
          	<div class="helper-text">
            	Enter multiple coordinates separated by semicolons (;)
          	</div>
          	<div class="helper-text" ng-if="c.parsedCoordinatesCount">
            	Parsed {{c.parsedCoordinatesCount}} coordinate(s)
          	</div>
        	</div>
      
      		<div class="form-group" ng-if="c.parsedManualCoordinates.length > 0">
        		<label class="form-label">Parsed Coordinates</label>
        		<div class="parsed-coords-list">
              <div ng-repeat="coord in c.parsedManualCoordinates" 
                class="parsed-coord-item"
                ng-click="c.navigateToSingleCoordinate(coord)">
          		<span class="coord-page">Page {{coord.page}}</span>
          		<span class="coord-details">{{coord.displayText}}</span>
        		</div>
      			</div>
    			</div>
    
          <div class="button-group">
            <button ng-click="c.navigateToManualCoordinates()" 
              ng-disabled="c.isLoading || !c.manualCoordinate"
              class="btn btn-primary">
              <i class="fas fa-location-dot"></i>
              Highlight All Coordinates
            </button>
            <button ng-click="c.copyCurrentCoordinates()" 
              ng-disabled="!c.activeField"
              class="btn btn-secondary">
              <i class="fas fa-copy"></i>
              Copy Active Coordinates
            </button>
          </div>
        </div>
			</div>

      <!-- Fields Section -->
      <div class="section">
        <div class="section-header">
          <h3 class="section-title">Fields</h3>
          <span class="field-count">
            {{c.getFilteredCount()}} of {{c.getTotalCount()}}
            <span ng-if="c.selectedDocument" class="text-xs text-gray-500">
              ({{c.selectedDocument.name}})
            </span>
          </span>
        </div>
  
    		<div class="search-wrapper">
      		<i class="fas fa-search search-icon"></i>
          <input type="text" 
            ng-model="c.fieldSearch" 
            ng-change="c.onSearchChange()"
            placeholder="Search fields..." 
            class="search-input">
    		</div>
  
        <!-- Optional: Show document filter info -->
        <div ng-if="c.selectedDocument" class="filter-info" style="padding: 8px; background: #f0f9ff; border-radius: 4px; margin-top: 8px; font-size: 12px;">
          <i class="fas fa-filter" style="color: #3b82f6; margin-right: 4px;"></i>
          Showing fields from: <strong>{{c.selectedDocument.name}}</strong>
          <span style="color: #64748b;">({{c.getDocumentFieldCount()}} fields)</span>
        </div>
			</div>

      <!-- Grouped Fields Table -->
      <div class="section fields-table-container" ng-if="true || c.groupedFields && Object.keys(c.groupedFields).length > 0">
    		<div ng-repeat="(sectionName, fields) in c.groupedFields" 
    			ng-show="c.getSectionFilteredCount(sectionName) > 0"
    			class="section-group">
    			<div class="section-group-header" 
            ng-click="c.toggleSection(sectionName)"
            ng-class="{'collapsed': c.collapsedSections[sectionName]}">
            <i class="fas fa-chevron-right section-toggle" 
              ng-class="{'rotate-90': !c.collapsedSections[sectionName]}">
            </i>
            <span class="section-group-title">{{sectionName || 'Uncategorized'}}</span>
            <span class="section-field-count">{{c.getSectionFilteredCount(sectionName)}}</span>
          </div>

          <table class="fields-table" ng-show="!c.collapsedSections[sectionName]">
            <thead>
              <tr>
                <th>Field Name</th>
                <th>Value</th>
                <th>Score</th>
                <th>Page</th>
                <th ng-if="!c.selectedDocument">File</th>
              </tr>
            </thead>
            <tbody>
        <tr ng-repeat="field in fields | filter:{field_name: c.fieldSearch}" 
          ng-show="!c.selectedDocument || (field.attachmentData.file_name === c.selectedDocument.name)"
          ng-click="c.navigateToField(field)"
          ng-class="{'active-row': field === c.activeField}">
          <td class="field-name">
            {{field.field_name}}
            <span ng-if="field.attachmentData && !c.selectedDocument" 
              style="display: block; font-size: 11px; color: #64748b;">
              {{field.attachmentData.file_name | limitTo:30}}{{field.attachmentData.file_name.length > 30 ? '...' : ''}}
            </span>
          </td>
          <td class="field-value">
            <span class="value-text" title="{{field.field_value}}">
              {{field.field_value || '-'}}
            </span>
          </td>
          <td>
            <div class="confidence-score" 
              ng-class="c.getConfidenceClass(field.confidence_indicator)"
              title="Confidence: {{(field.confidence_indicator * 100) | number:1}}%">
              {{(field.confidence_indicator * 100) | number:0}}%
            </div>
          </td>
          <td class="page-num">
            <span ng-if="!field.allCoordinates || field.allCoordinates.length === 0">-</span>
            <span ng-if="field.allCoordinates || field.allCoordinates.length === 1">
              {{field.allCoordinates[0].page}}
            </span>
            <!--<span ng-if="field.allCoordinates && field.allCoordinates.length > 1" 
              class="multi-page"
              title="{{field.allCoordinates.length}} coordinates">
              <i class="fas fa-layer-group"></i> {{field.allCoordinates.length}}
            </span> -->
          </td>
          <td ng-if="!c.selectedDocument" class="file-name" style="font-size: 11px; color: #64748b;">
            <span title="{{field.attachmentData.file_name}}">
              {{field.attachmentData.file_name | limitTo:20}}{{field.attachmentData.file_name.length > 20 ? '...' : ''}}
            </span>
          </td>
        </tr>
      </tbody>
          </table>
        </div>

      <!-- No Results Message -->
      <div ng-if="c.getFilteredCount() === 0 && c.fieldSearch" class="empty-state" style="padding: 20px; text-align: center;">
        <i class="fas fa-search" style="font-size: 32px; color: #cbd5e1; margin-bottom: 10px;"></i>
        <p style="color: #64748b;">No fields found matching "{{c.fieldSearch}}"</p>
        <button ng-click="c.fieldSearch = ''" class="btn btn-sm" style="margin-top: 10px;">
          Clear Search
        </button>
      </div>
     </div>

      <!-- No Data State -->
      <div class="empty-state" ng-if="(!c.groupedFields || Object.keys(c.groupedFields).length === 0) && c.selectedDocument && !c.isLoading">
        <i class="fas fa-inbox empty-icon"></i>
        <p>No field data available for this document</p>
      </div>
    </div>

    <!-- PDF Viewer Panel -->
    <div class="pdf-panel">
      <!-- PDF Header -->
      <div class="pdf-header">
        <div class="pdf-title">
          <i class="fas fa-file-pdf"></i>
          <span ng-if="c.selectedDocument">{{c.selectedDocument.name}}</span>
          <span ng-if="!c.selectedDocument">No document selected</span>
        </div>

        <div class="pdf-controls">
          <!-- Page Navigation -->
          <div class="control-group">
            <button ng-click="c.previousPage()" 
              ng-disabled="c.currentPage <= 1 || c.isLoading" 
              class="btn-icon"
              title="Previous Page">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="page-info">
              <span>Page {{c.currentPage}} of {{c.totalPages}}</span>
            </div>
            <button ng-click="c.nextPage()" 
              ng-disabled="c.currentPage >= c.totalPages || c.isLoading" 
              class="btn-icon"
              title="Next Page">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- PDF Content Area -->
      <div class="pdf-content" id="pdfContainer">
        <div class="pdf-canvas-wrapper">
          <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
          <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
          <div id="pageMarker" class="page-marker"></div>
        </div>
      </div>

      <!-- PDF Footer -->
      <div class="pdf-footer">
        <div class="footer-content">
          <span class="footer-item">
            <i class="fas fa-file"></i>
            A4: 595 Ã— 842 points
          </span>
          <span class="footer-item">
            <i class="fas fa-expand"></i>
            Scale: {{(c.scale * 100) | number:0}}%
          </span>
          <span class="footer-item" ng-if="c.activeField">
            <i class="fas fa-crosshairs"></i>
            Active: {{c.activeField.field_name}}
            <span ng-if="c.activeField.allCoordinates && c.activeField.allCoordinates.length > 1">
              ({{c.activeFieldCoordIndex + 1}}/{{c.activeField.allCoordinates.length}})
            </span>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>