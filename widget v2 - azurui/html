<!-- ============================================
     PDF-NAV Widget HTML Template
     ============================================
     Layout: Left sidebar (Fields) + Right panel (PDF Viewer)
     Features: Document selection, searchable fields table, save functionality
     ============================================ -->

<!-- External CSS Libraries -->
<link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
<link rel="stylesheet"
  href="https://fonts.googleapis.com/css2?display=swap&family=Segoe+UI:wght@300;400;600;700&family=Inter:wght@400;500;600;700" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<div class="pdf-viewer-container">

  <!-- ============================================
       LOADING OVERLAY
       Shows during data fetch/save operations
       ============================================ -->
  <div class="loading-overlay" ng-show="c.isLoading">
    <div class="loader-container">
      <div class="spinner"></div>
      <p class="loading-text">{{c.loadingMessage}}</p>
    </div>
  </div>

  <!-- ============================================
       MAIN LAYOUT
       Two-column layout: Fields (left) + PDF (right)
       ============================================ -->
  <div class="main-layout">

    <!-- ============================================
         LEFT SIDEBAR - FIELDS PANEL
         Contains: Header, Document selector, Search, Fields table
         ============================================ -->
    <div class="left-sidebar">

      <!-- Header with Title and Action Buttons -->
      <div class="fields-header">
        <div class="header-row">
          <h2 class="fields-title">Audit - #{{c.submissionNumber}}</h2>

          <!-- Action Buttons: Refer, Save, Done -->
          <div class="header-actions">
            <button class="btn-refer" ng-click="c.referSubmission()" ng-disabled="c.isLoading || c.isSaving">
              Refer
            </button>
            <button class="btn-save" ng-click="c.saveAllChanges()"
              ng-disabled="c.isLoading || c.isSaving || !c.hasChanges">
              <i class="fas fa-spinner fa-spin" ng-show="c.isSaving"></i>
              <span ng-hide="c.isSaving">Save</span>
              <span ng-show="c.isSaving">Saving...</span>
            </button>
            <button class="btn-done" ng-click="c.markAsComplete()"
              ng-disabled="c.isLoading || c.isSaving || c.isCompleting">
              <i class="fas fa-spinner fa-spin" ng-show="c.isCompleting"></i>
              <span ng-hide="c.isCompleting">Complete</span>
              <span ng-show="c.isCompleting">Completing...</span>
          </div>
        </div>

        <!-- Document Selector Dropdown with Filter Toggle -->
        <div class="document-selector-row">
          <select ng-model="c.selectedDocument" ng-change="c.loadDocument()" ng-disabled="c.isLoading"
            ng-options="doc as doc.name for doc in c.documents track by doc.url" class="document-dropdown">
          </select>
          <button class="btn-filter-toggle" ng-click="c.toggleDocumentFilter()"
            ng-class="{'active': c.filterDocumentOnly}"
            title="{{c.filterDocumentOnly ? 'Showing fields with source only - Click to show all' : 'Showing all fields - Click to filter by document & source'}}">
            <i class="fas" ng-class="c.filterDocumentOnly ? 'fa-filter' : 'fa-filter'"></i>
            <span class="filter-count" ng-show="c.filterDocumentOnly">{{c.getVisibleFieldCount()}}</span>
          </button>
        </div>

        <!-- Search Input -->
        <div class="search-wrapper">
          <i class="fas fa-search search-icon"></i>
          <input type="text" ng-model="c.fieldSearch" placeholder="Search fields..." class="search-input">
        </div>
      </div>

      <!-- ============================================
           FIELDS CONTENT
           Grouped sections with expandable tables
           ============================================ -->
      <div class="fields-content">

        <!-- Loop through grouped field sections -->
        <div ng-repeat="(sectionName, fields) in c.groupedFields" class="field-section">

          <!-- Section Header (Collapsible) -->
          <div class="section-header" ng-click="c.collapsedSections[sectionName] = !c.collapsedSections[sectionName]">
            <div class="section-title-wrapper">
              <i class="fas" ng-class="c.collapsedSections[sectionName] ? 'fa-chevron-right' : 'fa-chevron-down'"></i>
              <span class="section-title">{{c.trimInitialNumberAdvanced(sectionName)}} ({{fields.length}})</span>
            </div>
            <div class="section-accuracy" ng-if="fields.length > 0" ng-class="c.getSectionAccuracyClass(fields)">
              {{c.calculateSectionAccuracy(fields) | number:0}}%
            </div>
          </div>

          <!-- Section Table (Fields) -->
          <div class="section-table-wrapper" ng-show="!c.collapsedSections[sectionName]">
            <table class="fields-table">
              <thead>
                <tr>
                  <th class="col-field-name">Field Name</th>
                  <th class="col-ai-value">AI Value</th>
                  <th class="col-data-verification">Data Verification</th>
                  <th class="col-qa-override">QA Override Value</th>
                  <th class="col-logic">Logic Transparency</th>
                  <th class="col-commentary">Commentary</th>
                </tr>
              </thead>
              <tbody>
                <!-- Field Rows (filtered by shouldShowField when toggle is on) -->
                <tr ng-repeat="field in fields | filter:{field_name: c.fieldSearch}" ng-if="c.shouldShowField(field)"
                  ng-click="c.isFieldActive(field) && c.navigateToField(field)" ng-class="{
                      'active-field': field === c.isFieldActive(field),
                      'inactive-field': !c.isFieldActive(field),
                      'no-navigate': !c.canNavigate(field)
                    }">

                  <!-- Field Name + Source Indicator + Confidence -->
                  <td class="col-field-name">
                    <div class="field-name-cell">
                      <i class="fas fa-crosshairs source-indicator" ng-if="field.source && field.source.length > 0"
                        title="Has source coordinates"></i>
                      <span class="field-name" title="{{field.field_name}}">{{field.field_name}}</span>
                      <span class="confidence-pill" ng-class="c.getConfidencePillClass(field.confidence_indicator)">
                        {{field.confidence_indicator * 100 | number:0}}%
                      </span>
                    </div>
                  </td>

                  <!-- AI Value (Read-only with title tooltip) -->
                  <td class="col-ai-value">
                    <span class="cell-text" ng-class="{'has-value': field.field_value}" title="{{field.field_value}}">
                      {{c.truncateText(field.field_value, 15) || '-'}}
                    </span>
                  </td>

                  <!-- Data Verification (Editable when status = 'a', otherwise read-only) -->
                  <td class="col-data-verification" ng-click="$event.stopPropagation()">
                    <!-- Editable input when submission_status_choice is 'a' -->
                    <input type="text" class="verification-input" ng-model="field.data_verification"
                      ng-if="c.submissionStatusChoice !== c.qaKey" ng-change="c.markFieldAsChanged(field)"
                      ng-blur="c.validateCommentary(field); c.autoSaveField(field)"
                      ng-disabled="false && !c.isFieldActive(field)" placeholder="Enter...">
                    <!-- Read-only text when submission_status_choice is not 'a' -->
                    <span class="cell-text" ng-if="c.submissionStatusChoice === c.qaKey"
                      title="{{field.data_verification}}">
                      {{c.truncateText(field.data_verification, 12) || '-'}}
                    </span>
                  </td>

                  <!-- QA Override Value (Editable when status = 'b', otherwise read-only) -->
                  <td class="col-qa-override" ng-click="$event.stopPropagation()">
                    <!-- Editable input when submission_status_choice is 'b' -->
                    <input type="text" class="override-input" ng-model="field.qa_override_value"
                      ng-if="c.submissionStatusChoice === c.qaKey" ng-change="c.markFieldAsChanged(field)"
                      ng-blur="c.validateCommentary(field); c.autoSaveField(field)"
                      ng-disabled="false && !c.isFieldActive(field)" placeholder="Enter...">
                    <!-- Read-only text when submission_status_choice is not 'b' -->
                    <span class="cell-text" ng-if="c.submissionStatusChoice !== c.qaKey"
                      title="{{field.qa_override_value}}">
                      {{c.truncateText(field.qa_override_value, 12) || '-'}}
                    </span>
                  </td>

                  <!-- Logic Transparency (Always truncated with title tooltip) -->
                  <td class="col-logic">
                    <span class="cell-text" ng-class="{'has-value': field.logic_transparency}"
                      title="{{field.logic_transparency}}">
                      {{c.truncateText(field.logic_transparency, 15) || '-'}}
                    </span>
                  </td>

                  <!-- Commentary (Editable input field) -->
                  <td class="col-commentary" ng-click="$event.stopPropagation()">
                    <input type="text" class="commentary-input" ng-model="field.commentary"
                      ng-class="{'validation-error': field.commentaryRequired}"
                      ng-change="c.markFieldAsChanged(field); field.commentaryRequired = false;"
                      ng-blur="c.autoSaveField(field)" placeholder="Enter...">
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" ng-if="!c.groupedFields || c.getObjectKeys(c.groupedFields).length === 0">
          <i class="fas fa-file-alt empty-icon"></i>
          <p>No fields available</p>
          <p class="empty-hint" ng-if="!c.isLoading">Select a document to view extracted fields</p>
        </div>
      </div>

      <!-- Save Status Bar -->
      <div class="save-status-bar"
        ng-class="{'saving': c.saveStatus === 'saving', 'saved': c.saveStatus === 'saved', 'error': c.saveStatus === 'error'}"
        ng-show="c.saveStatus">
        <i class="fas fa-spinner fa-spin" ng-show="c.saveStatus === 'saving'"></i>
        <i class="fas fa-check-circle" ng-show="c.saveStatus === 'saved'"></i>
        <i class="fas fa-exclamation-circle" ng-show="c.saveStatus === 'error'"></i>
        <span>{{c.saveStatusMessage}}</span>
      </div>
    </div>

    <!-- ============================================
         RIGHT PANEL - PDF VIEWER
         Contains: Header, Canvas, Footer
         ============================================ -->
    <div class="pdf-panel">

      <!-- PDF Header -->
      <div class="pdf-header">
        <div class="pdf-title">
          <i class="fas fa-file-pdf"></i>
          <span ng-if="c.selectedDocument">{{c.selectedDocument.name}}</span>
          <span ng-if="!c.selectedDocument">No document selected</span>
        </div>

        <div class="pdf-controls">
          <!-- Zoom Controls -->
          <div class="control-group">
            <button ng-click="c.fitWidth()" ng-disabled="c.isLoading || !c.pdfLoaded" class="btn-icon"
              ng-class="{'active': c.zoomMode === 'fit-width'}" title="Fit to Width">
              <i class="fa-solid fa-arrows-left-right-to-line"></i>
            </button>
            <button ng-click="c.actual100Percent()" ng-disabled="c.isLoading || !c.pdfLoaded" class="btn-icon"
              ng-class="{'active': c.zoomMode === 'actual-size'}" title="Actual Size (100%)">
              <i class="fa-solid fa-text-height"></i>
            </button>
          </div>

          <!-- Page Navigation -->
          <div class="control-group">
            <button ng-click="c.previousPage()" ng-disabled="c.currentPage <= 1 || c.isLoading" class="btn-icon"
              title="Previous Page">
              <i class="fas fa-chevron-left"></i>
            </button>
            <div class="page-info">
              <span>Page {{c.currentPage}} of {{c.totalPages}}</span>
            </div>
            <button ng-click="c.nextPage()" ng-disabled="c.currentPage >= c.totalPages || c.isLoading" class="btn-icon"
              title="Next Page">
              <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- PDF Content Area -->
      <div class="pdf-content" id="pdfContainer">
        <!-- PDF Loading Overlay -->
        <div class="pdf-loading-overlay" ng-show="c.isPdfLoading">
          <div class="pdf-loader">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Loading PDF...</span>
          </div>
        </div>
        <div class="pdf-canvas-wrapper">
          <canvas id="pdfCanvas" class="pdf-canvas"></canvas>
          <canvas id="annotationCanvas" class="annotation-canvas"></canvas>
          <div id="pageMarker" class="page-marker"></div>
        </div>
      </div>

      <!-- PDF Footer -->
      <div class="pdf-footer">
        <div class="footer-content">
          <span class="footer-item">
            <i class="fas fa-file"></i>
            A4: 595 Ã— 842 points
          </span>
          <span class="footer-item">
            <i class="fas fa-expand"></i>
            Scale: {{(c.scale * 100) | number:0}}%
          </span>
          <span class="footer-item" ng-if="c.activeField">
            <i class="fas fa-crosshairs"></i>
            Active: {{c.activeField.field_name}}
            <span ng-if="c.activeField.allCoordinates && c.activeField.allCoordinates.length > 1">
              ({{c.activeFieldCoordIndex + 1}}/{{c.activeField.allCoordinates.length}})
            </span>
          </span>
        </div>
      </div>
    </div>
  </div>
</div>