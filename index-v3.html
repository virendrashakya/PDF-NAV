<!DOCTYPE html>
<html ng-app="pdfApp">
<head>
    <meta charset="UTF-8">
    <title>Data Viewer</title>
    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;700;900&family=Noto+Sans:wght@400;500;700;900" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.2/angular.min.js"></script>
</head>
<body ng-controller="PdfNavigatorController" class="bg-white">
    <div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
        <div class="layout-container flex h-full grow flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f5f3f0] px-10 py-3">
                <div class="flex items-center gap-4 text-[#181611]">
                    <div class="size-4">
                        <svg viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M44 4H30.6666V17.3334H17.3334V30.6666H4V44H44V4Z" fill="currentColor"></path>
                        </svg>
                    </div>
                    <h2 class="text-[#181611] text-lg font-bold leading-tight tracking-[-0.015em]">Data Viewer</h2>
                </div>
                <div class="flex flex-1 justify-end gap-8">
                    <div class="flex items-center gap-9">
                        <a class="text-[#181611] text-sm font-medium leading-normal" href="#">Home</a>
                        <a class="text-[#181611] text-sm font-medium leading-normal" href="#">Upload</a>
                        <a class="text-[#181611] text-sm font-medium leading-normal" href="#">Settings</a>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <div class="gap-1 px-6 flex flex-1 justify-center py-5">
                <!-- Sidebar -->
                <div class="layout-content-container flex flex-col w-80">
                    <h2 class="text-[#181611] text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Data Fields</h2>
                    
                    <!-- Search Box -->
                    <div class="px-4 py-3">
                        <label class="flex flex-col min-w-40 h-12 w-full">
                            <div class="flex w-full flex-1 items-stretch rounded-lg h-full">
                                <div class="text-[#8a7c60] flex border-none bg-[#f5f3f0] items-center justify-center pl-4 rounded-l-lg border-r-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                        <path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path>
                                    </svg>
                                </div>
                                <input placeholder="Search data fields" 
                                       ng-model="searchQuery"
                                       class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#181611] focus:outline-0 focus:ring-0 border-none bg-[#f5f3f0] focus:border-none h-full placeholder:text-[#8a7c60] px-4 rounded-l-none border-l-0 pl-2 text-base font-normal leading-normal">
                            </div>
                        </label>
                    </div>

                    <!-- Upload Button -->
                    <div class="flex px-4 py-3 justify-start">
                        <button ng-click="showUploadModal()" 
                                class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 bg-[#f2a20d] text-[#181611] gap-2 pl-4 text-sm font-bold leading-normal tracking-[0.015em]">
                            <div class="text-[#181611]">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path>
                                </svg>
                            </div>
                            <span class="truncate">Upload</span>
                        </button>
                    </div>

                    <!-- Upload Modal -->
                    <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" 
                         ng-show="showModal" 
                         ng-click="closeModal($event)">
                        <div class="bg-white rounded-2xl w-full max-w-2xl p-6 mx-4" 
                             ng-click="$event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold text-[#181611]">Upload Files</h3>
                                <button ng-click="closeModal()" 
                                        class="text-[#8a7c60] hover:text-[#181611]">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                        <path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="space-y-4">
                                <!-- PDF Dropzone -->
                                <div class="border-2 border-dashed border-[#e6e2db] rounded-lg p-8 text-center"
                                     ng-class="{'border-[#f2a20d] bg-[#fff9e6]': isDraggingPdf}"
                                     ondragover="angular.element(this).scope().handleDragOver($event, 'pdf')"
                                     ondragleave="angular.element(this).scope().handleDragLeave($event, 'pdf')"
                                     ondrop="angular.element(this).scope().handleDrop($event, 'pdf')">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="size-12 flex items-center justify-center rounded-full bg-[#fff9e6]">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="#f2a20d" viewBox="0 0 256 256">
                                                <path d="M224,152v56a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V152a8,8,0,0,1,16,0v56H208V152a8,8,0,0,1,16,0ZM77.66,77.66a8,8,0,0,1,11.31,0L120,108.69V40a8,8,0,0,1,16,0v68.69l31-31a8,8,0,0,1,11.31,11.31l-44.34,44.34a8,8,0,0,1-11.31,0L77.66,89A8,8,0,0,1,77.66,77.66Z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-[#181611] font-bold mb-1">Upload PDF File</h4>
                                            <p class="text-[#8a7c60] text-sm">Drag & drop your PDF file here or</p>
                                        </div>
                                        <label class="cursor-pointer text-[#f2a20d] hover:text-[#181611] font-medium">
                                            Browse Files
                                            <input type="file" 
                                                   accept="application/pdf" 
                                                   class="hidden"
                                                   file-model="pdfFile"
                                                   onchange="angular.element(this).scope().handleFileSelect(this, 'pdf')">
                                        </label>
                                    </div>
                                </div>

                                <!-- JSON Dropzone -->
                                <div class="border-2 border-dashed border-[#e6e2db] rounded-lg p-8 text-center"
                                     ng-class="{'border-[#f2a20d] bg-[#fff9e6]': isDraggingJson}"
                                     ondragover="angular.element(this).scope().handleDragOver($event, 'json')"
                                     ondragleave="angular.element(this).scope().handleDragLeave($event, 'json')"
                                     ondrop="angular.element(this).scope().handleDrop($event, 'json')">
                                    <div class="flex flex-col items-center gap-3">
                                        <div class="size-12 flex items-center justify-center rounded-full bg-[#fff9e6]">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="#f2a20d" viewBox="0 0 256 256">
                                                <path d="M224,152v56a16,16,0,0,1-16,16H48a16,16,0,0,1-16-16V152a8,8,0,0,1,16,0v56H208V152a8,8,0,0,1,16,0ZM77.66,77.66a8,8,0,0,1,11.31,0L120,108.69V40a8,8,0,0,1,16,0v68.69l31-31a8,8,0,0,1,11.31,11.31l-44.34,44.34a8,8,0,0,1-11.31,0L77.66,89A8,8,0,0,1,77.66,77.66Z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h4 class="text-[#181611] font-bold mb-1">Upload JSON File</h4>
                                            <p class="text-[#8a7c60] text-sm">Drag & drop your JSON file here or</p>
                                        </div>
                                        <label class="cursor-pointer text-[#f2a20d] hover:text-[#181611] font-medium">
                                            Browse Files
                                            <input type="file" 
                                                   accept="application/json" 
                                                   class="hidden"
                                                   file-model="jsonFile"
                                                   onchange="angular.element(this).scope().handleFileSelect(this, 'json')">
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="flex justify-end gap-3 mt-6">
                                <button ng-click="closeModal()" 
                                        class="px-4 py-2 rounded-lg border border-[#e6e2db] text-[#181611] hover:bg-[#f5f3f0]">
                                    Cancel
                                </button>
                                <button ng-click="uploadFiles()" 
                                        ng-disabled="!pdfFile || !jsonFile"
                                        class="px-4 py-2 rounded-lg bg-[#f2a20d] text-[#181611] font-medium disabled:opacity-50">
                                    Upload Files
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Coordinate Input Fields -->
                    <div class="px-4 py-3">
                        <div class="bg-white rounded-lg border border-[#e6e2db] p-4 mb-4">
                            <h3 class="text-[#181611] text-sm font-bold mb-3">Polygon Coordinates</h3>
                            <input type="text" 
                                   ng-model="coordinateString" 
                                   placeholder="D(page,x1,y1,x2,y2,x3,y3,x4,y4)"
                                   class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#181611] focus:outline-0 focus:ring-0 border border-[#e6e2db] bg-white focus:border-[#e6e2db] h-14 placeholder:text-[#8a7c60] p-[15px] text-base font-normal leading-normal mb-3">
                            
                            <button ng-click="parseCoordinates()" 
                                    class="w-full flex items-center justify-center rounded-lg h-10 px-4 bg-[#f2a20d] text-[#181611] text-sm font-bold">
                                Parse Coordinates
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="text-sm text-[#8a7c60] font-medium">Parsed Coordinates:</div>
                            <div ng-repeat="coord in coordinates" class="bg-[#f5f3f0] rounded-lg p-3 flex items-center justify-between">
                                <div class="text-sm text-[#181611]">
                                    Page {{coord.page}} - ({{coord.x}}, {{coord.y}})
                                </div>
                                <button ng-click="navigateToCoordinate(coord)" 
                                        class="text-[#f2a20d] hover:text-[#181611]">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256">
                                        <path d="M237.66,133.66l-96,96A8,8,0,0,1,128,224V176H48a8,8,0,0,1-8-8V88a8,8,0,0,1,8-8h80V32a8,8,0,0,1,13.66-5.66l96,96A8,8,0,0,1,237.66,133.66Z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main PDF Viewer -->
                <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
                    <div class="flex flex-wrap justify-between gap-3 p-4">
                        <h2 class="text-[#181611] tracking-light text-[32px] font-bold leading-tight min-w-72">PDF Viewer</h2>
                    </div>
                    
                    <!-- PDF Controls -->
                    <div class="flex items-center gap-2 p-4 bg-[#f5f3f0] rounded-lg mb-4">
                        <button ng-click="previousPage()" 
                                ng-disabled="currentPage <= 1"
                                class="p-2 rounded hover:bg-white disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M168.49,199.51a12,12,0,0,1-17,17l-80-80a12,12,0,0,1,0-17l80-80a12,12,0,0,1,17,17L97,128Z"></path>
                            </svg>
                        </button>
                        <span class="text-sm font-medium">Page {{currentPage}} of {{totalPages}}</span>
                        <button ng-click="nextPage()" 
                                ng-disabled="currentPage >= totalPages"
                                class="p-2 rounded hover:bg-white disabled:opacity-50">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M184.49,136.51l-80,80a12,12,0,0,1-17-17L159,128,87.51,56.49a12,12,0,0,1,17-17l80,80A12,12,0,0,1,184.49,136.51Z"></path>
                            </svg>
                        </button>
                        <div class="flex-1"></div>
                        <button ng-click="zoomOut()" class="p-2 rounded hover:bg-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M228.24,219.76l-51.38-51.38a86.15,86.15,0,1,0-8.48,8.48l51.38,51.38a6,6,0,0,0,8.48-8.48ZM38,112a74,74,0,1,1,74,74A74.09,74.09,0,0,1,38,112Z M144,106H80a6,6,0,0,0,0,12h64a6,6,0,0,0,0-12Z"></path>
                            </svg>
                        </button>
                        <button ng-click="zoomIn()" class="p-2 rounded hover:bg-white">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                <path d="M228.24,219.76l-51.38-51.38a86.15,86.15,0,1,0-8.48,8.48l51.38,51.38a6,6,0,0,0,8.48-8.48ZM38,112a74,74,0,1,1,74,74A74.09,74.09,0,0,1,38,112Zm98-6H118V88a6,6,0,0,0-12,0v18H88a6,6,0,0,0,0,12h18v18a6,6,0,0,0,12,0V118h18a6,6,0,0,0,0-12Z"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- PDF Canvas -->
                    <div class="pdf-container relative bg-[#f5f3f0] rounded-lg overflow-auto" style="height: calc(100vh - 280px);">
                        <canvas id="pdfCanvas" class="mx-auto"></canvas>
                        <div id="pageMarker" class="absolute hidden w-6 h-6 bg-[#f2a20d] rounded-full transform -translate-x-1/2 -translate-y-1/2 pointer-events-none"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js';

        angular.module('pdfApp', [])
            .controller('PdfNavigatorController', ['$scope', '$timeout', function($scope, $timeout) {
                // Initialize variables
                $scope.pdfLoaded = false;
                $scope.isUploading = false;
                $scope.coordinates = [];
                $scope.newCoordinate = {};
                $scope.scale = 1.0;
                $scope.currentPage = 1;
                $scope.totalPages = 0;
                $scope.activeMarker = null;
                $scope.jsonData = null;
                $scope.activeField = null;
                $scope.fieldSearch = '';
                $scope.Math = Math;
                $scope.showModal = false;
                $scope.isDraggingPdf = false;
                $scope.isDraggingJson = false;
                $scope.pdfFile = null;
                $scope.jsonFile = null;

                $scope.newPolygon = {
                    page: 1,
                    x1: null, y1: null,
                    x2: null, y2: null,
                    x3: null, y3: null,
                    x4: null, y4: null
                };
                
                $scope.polygons = [];
                $scope.coordinateString = '';
                
                let pdfDoc = null;
                let canvas = null;
                let ctx = null;
                $scope.showUploadModal = function() {
                    $scope.showModal = true;
                };

                // File Upload Handlers
                $scope.uploadPdf = function(file) {
                    if (!file) return;
                    
                    $scope.isUploading = true;
                    $scope.$apply();
                    
                    const fileReader = new FileReader();
                    fileReader.onload = function(e) {
                        const pdfData = new Uint8Array(e.target.result);
                        loadPdf(pdfData);
                    };
                    fileReader.readAsArrayBuffer(file);
                };
                
                $scope.uploadJson = function(file) {
                    if (!file) return;
                    
                    const fileReader = new FileReader();
                    fileReader.onload = function(e) {
                        try {
                            const jsonData = JSON.parse(e.target.result);
                            $scope.$apply(function() {
                                $scope.jsonData = jsonData;
                                $scope.coordinates = [];
                                if (jsonData && jsonData.extracted_data && jsonData.extracted_data.fields) {
                                    Object.entries(jsonData.extracted_data.fields).forEach(([key, value]) => {
                                        if (value.source) {
                                            const coord = $scope.parseSourceCoordinate(value.source);
                                            if (coord) {
                                                $scope.coordinates.push({
                                                    ...coord,
                                                    fieldName: key,
                                                    confidence: value.confidence || 0
                                                });
                                            }
                                        }
                                    });
                                }
                            });
                        } catch (error) {
                            console.error('Error parsing JSON:', error);
                        }
                    };
                    fileReader.readAsText(file, 'UTF-8');
                };

                $scope.closeModal = function(event) {
                    if (event) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    $scope.showModal = false;
                    $scope.pdfFile = null;
                    $scope.jsonFile = null;
                    $scope.isDraggingPdf = false;
                    $scope.isDraggingJson = false;
                };

                // File Handling
                $scope.handleDragOver = function(event, type) {
                    event.preventDefault();
                    event.stopPropagation();
                    if (type === 'pdf') {
                        $scope.isDraggingPdf = true;
                    } else {
                        $scope.isDraggingJson = true;
                    }
                    $scope.$apply();
                };

                $scope.handleDragLeave = function(event, type) {
                    event.preventDefault();
                    event.stopPropagation();
                    if (type === 'pdf') {
                        $scope.isDraggingPdf = false;
                    } else {
                        $scope.isDraggingJson = false;
                    }
                    $scope.$apply();
                };

                $scope.handleDrop = function(event, type) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        const file = files[0];
                        if (type === 'pdf' && (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))) {
                            $scope.pdfFile = file;
                            $scope.uploadPdf(file);
                        } else if (type === 'json' && (file.type === 'application/json' || file.name.toLowerCase().endsWith('.json'))) {
                            $scope.jsonFile = file;
                            $scope.uploadJson(file);
                        }
                    }
                    
                    $scope.isDraggingPdf = false;
                    $scope.isDraggingJson = false;
                    $scope.$apply();
                };

                $scope.handleFileSelect = function(element, type) {
                    const file = element.files[0];
                    if (!file) return;
                    
                    if (type === 'pdf') {
                        $scope.pdfFile = file;
                        $scope.uploadPdf(file);
                    } else if (type === 'json') {
                        $scope.jsonFile = file;
                        $scope.uploadJson(file);
                    }
                    $scope.$apply();
                };

                // File selection handler
                $scope.handleFileSelect = function(element, type) {
                    if (!element || !element.files || !element.files[0]) return;
                    
                    const file = element.files[0];
                    const updateScope = function() {
                        if (type === 'pdf' && (file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf'))) {
                            $scope.pdfFile = file;
                        } else if (type === 'json' && (file.type === 'application/json' || file.name.toLowerCase().endsWith('.json'))) {
                            $scope.jsonFile = file;
                        }
                    };
                    
                    if ($scope.$$phase) {
                        updateScope();
                    } else {
                        $scope.$apply(updateScope);
                    }
                };

                // Load PDF function
                function loadPdf(pdfData) {
                    pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                        $scope.$apply(function() {
                            $scope.pdfDoc = pdf;
                            $scope.totalPages = pdf.numPages;
                            $scope.currentPage = 1;
                            renderPage($scope.currentPage);
                        });
                    }).catch(function(error) {
                        console.error('Error loading PDF:', error);
                    });
                }

                // Render page function
                function renderPage(pageNumber) {
                    $scope.pdfDoc.getPage(pageNumber).then(function(page) {
                        const canvas = document.getElementById('pdfCanvas');
                        const ctx = canvas.getContext('2d');
                        
                        const viewport = page.getViewport({ scale: $scope.scale });
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;

                        const renderContext = {
                            canvasContext: ctx,
                            viewport: viewport
                        };

                        return page.render(renderContext).promise;
                    }).catch(function(error) {
                        console.error('Error rendering page:', error);
                    });
                }

                // Upload Files Handler
                $scope.uploadFiles = function() {
                    if ($scope.pdfFile) {
                        $scope.uploadPdf($scope.pdfFile);
                    }
                    if ($scope.jsonFile) {
                        $scope.uploadJson($scope.jsonFile);
                    }
                    $scope.closeModal();
                };

                // PDF Loading and Rendering
                function loadPdf(pdfData) {
                    pdfjsLib.getDocument(pdfData).promise.then(function(pdf) {
                        pdfDoc = pdf;
                        $scope.$apply(function() {
                            $scope.pdfLoaded = true;
                            $scope.isUploading = false;
                            $scope.totalPages = pdf.numPages;
                            $scope.currentPage = 1;
                        });
                        return $scope.renderPage($scope.currentPage);
                    }).catch(function(error) {
                        console.error('Error loading PDF:', error);
                        $scope.$apply(function() {
                            $scope.isUploading = false;
                        });
                    });
                }

                $scope.renderPage = function(pageNumber) {
                    if (!pdfDoc) return Promise.reject('No PDF document');
                    
                    return pdfDoc.getPage(pageNumber).then(function(page) {
                        canvas = document.getElementById('pdfCanvas');
                        ctx = canvas.getContext('2d');
                        
                        const viewport = page.getViewport({ scale: $scope.scale });
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        const renderContext = {
                            canvasContext: ctx,
                            viewport: viewport
                        };
                        
                        return page.render(renderContext).promise;
                    });
                };
                        
                        // Close the modal
                        $scope.closeModal();
                    }
                };

                // Navigation functions
                $scope.nextPage = function() {
                    if ($scope.currentPage < $scope.totalPages) {
                        $scope.currentPage++;
                        renderPage($scope.currentPage);
                    }
                };

                $scope.previousPage = function() {
                    if ($scope.currentPage > 1) {
                        $scope.currentPage--;
                        renderPage($scope.currentPage);
                    }
                };

                $scope.zoomIn = function() {
                    $scope.scale *= 1.2;
                    renderPage($scope.currentPage);
                };

                $scope.zoomOut = function() {
                    $scope.scale *= 0.8;
                    renderPage($scope.currentPage);
                };

                // Your existing controller code here...
            });
    </script>
</body>
</html>
